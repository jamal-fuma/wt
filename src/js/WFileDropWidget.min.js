WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",function(k,b,r){jQuery.data(b,"lobj",this);var c=this,o="Wt-filedropzone-hover",d=[],p=false,j=true,n=false,q=false,l=0,h=document.createElement("input");h.type="file";h.setAttribute("multiple","multiple");$(h).hide();b.appendChild(h);var g=document.createElement("div");$(g).addClass("Wt-dropcover");document.body.appendChild(g);this.eventContainsFile=function(a){var e=a.dataTransfer.types!=null&&a.dataTransfer.types.length>0&&a.dataTransfer.types[0]==
"Files";return a.dataTransfer.items!=null&&a.dataTransfer.items.length>0&&a.dataTransfer.items[0].kind=="file"||e};this.validFileCheck=function(a,e,i){var f=new FileReader;f.onload=function(){e(true,i)};f.onerror=function(){e(false,i)};f.readAsText(a.slice(0,32))};b.setAcceptDrops=function(a){j=a};b.setBodyAware=function(a){n=a};b.setDropForward=function(a){q=a};b.ondragenter=function(a){if(j){if(c.eventContainsFile(a)){l=2;c.setHoverStyle(true)}a.stopPropagation()}};b.ondragleave=function(a){if(document.elementFromPoint(a.clientX,
a.clientY)===g)l=1;else j&&c.setHoverStyle(false)};b.ondragover=function(a){a.preventDefault()};bodyDragEnter=function(){if(n&&$(b).is(":visible")){l=1;c.setHoverStyle(true)}};document.body.addEventListener("dragenter",bodyDragEnter);g.ondragover=function(a){a.preventDefault();a.stopPropagation()};g.ondragleave=function(){!j||l!=1||c.setHoverStyle(false)};g.ondrop=function(a){a.preventDefault();q?b.ondrop(a):c.setHoverStyle(false)};b.ondrop=function(a){a.preventDefault();if(j){c.setHoverStyle(false);
window.FormData===undefined||a.dataTransfer.files==null||a.dataTransfer.files.length==0||c.addFiles(a.dataTransfer.files)}};this.addFiles=function(a){for(var e=[],i=0;i<a.length;i++){var f=new XMLHttpRequest;f.id=Math.floor(Math.random()*Math.pow(2,31));f.file=a[i];d.push(f);var m={};m.id=f.id;m.filename=f.file.name;m.type=f.file.type;m.size=f.file.size;e.push(m)}k.emit(b,"dropsignal",JSON.stringify(e))};b.addEventListener("click",function(){if(j){$(h).val("");h.click()}});b.markForSending=function(a){for(var e=
0;e<a.length;e++)for(var i=a[e].id,f=0;f<d.length;f++)if(d[f].id==i){d[f].ready=true;break}p||d[0].ready&&c.requestSend()};this.requestSend=function(){if(d[0].skip)c.uploadFinished(null);else{p=true;k.emit(b,"requestsend",d[0].id)}};b.send=function(a){xhr=d[0];if(xhr.file.size>r){k.emit(b,"filetoolarge",xhr.file.size);c.uploadFinished(null)}else c.validFileCheck(xhr.file,c.actualSend,a)};this.actualSend=function(a,e){if(a){xhr=d[0];xhr.addEventListener("load",c.uploadFinished);xhr.addEventListener("error",
c.uploadFinished);xhr.addEventListener("abort",c.uploadFinished);xhr.addEventListener("timeout",c.uploadFinished);xhr.open("POST",e);a=new FormData;a.append("file-id",xhr.id);a.append("data",xhr.file);xhr.send(a)}else c.uploadFinished(null)};this.uploadFinished=function(a){a!=null&&a.type=="load"&&a.currentTarget.status==200&&k.emit(b,"uploadfinished",d[0].id);d.splice(0,1);if(d[0]&&d[0].ready)c.requestSend();else{p=false;k.emit(b,"donesending")}};b.cancelUpload=function(a){if(d[0]&&d[0].id==a)d[0].abort();
else for(var e=1;e<d.length;e++)if(d[e].id==a)d[e].skip=true};h.onchange=function(){if(j)window.FormData===undefined||this.files==null||this.files.length==0||c.addFiles(this.files)};this.setHoverStyle=function(a){if(a){$(b).addClass(o);if(n){$(b).addClass("drag-style");$(g).addClass("drag-style")}}else{$(b).removeClass(o);if(n){$(b).removeClass("drag-style");$(g).removeClass("drag-style")}l=0}};b.configureHoverClass=function(a){o=a};b.setFilters=function(a){h.setAttribute("accept",a)};b.destructor=
function(){document.body.removeEventListener("dragenter",bodyDragEnter);document.body.removeChild(g)}});
